{
	"name": "SVV_TRAFIKKDATA_TRANSFORM_SQL",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "SVV_BLOB_INPUT_CSV",
						"type": "DatasetReference"
					},
					"name": "source1"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "AZURE_SQL_DB_LINK",
						"type": "LinkedServiceReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [
				{
					"name": "Filter1"
				},
				{
					"name": "DerivedColumn1"
				},
				{
					"name": "Select1"
				},
				{
					"name": "Filter2"
				},
				{
					"name": "DerivedColumn3"
				},
				{
					"name": "Aggregate2"
				},
				{
					"name": "Join1"
				},
				{
					"name": "Filter3"
				},
				{
					"name": "DerivedColumn4"
				},
				{
					"name": "Aggregate3"
				},
				{
					"name": "Join2"
				}
			],
			"script": "parameters{\n\tArr as string[] (split(toString(Volum),';'))\n}\nsource(output(\n\t\tTrafikkregistreringspunkt as string,\n\t\tNavn as string,\n\t\tVegreferanse as string,\n\t\tFra as string,\n\t\tTil as string,\n\t\t{År} as short,\n\t\t{Måned} as short,\n\t\tVolum as integer,\n\t\t{Konfidensintervall start} as integer,\n\t\t{Konfidensintervall slutt} as integer,\n\t\t{Dekningsgrad (%)} as string,\n\t\t{Antall døgn total} as short,\n\t\t{Antall døgn inkludert} as short,\n\t\t{Antall døgn ugyldig} as short,\n\t\t{Ikke gyldig lengde} as short,\n\t\t{Lengdekvalitetsgrad (%)} as string,\n\t\tFelt as string,\n\t\t{< 5,6m} as integer,\n\t\t{>= 5,6m} as short,\n\t\t{5,6m - 7,6m} as short,\n\t\t{7,6m - 12,5m} as short,\n\t\t{12,5m - 16,0m} as short,\n\t\t{16,0m - 24,0m} as short,\n\t\t{>= 24,0m} as short\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\twildcardPaths:['SVV-data.csv']) ~> source1\nsource1 filter((Trafikkregistreringspunkt == \"68804V121330\" && Felt == \"Totalt i retning Oddernestunnelen\") ||\r\n(Trafikkregistreringspunkt == \"02466V121760\" && Felt == \"Totalt i retning KRISTIANSAND\") ||\r\n(Trafikkregistreringspunkt == \"04813V121368\" && Felt == \"Totalt i retning Kristiansand\") ||\r\n(Trafikkregistreringspunkt == \"22540V121303\" && Felt == \"Totalt i retning KRISTIANSAND\") ||\r\n(Trafikkregistreringspunkt == \"16947V121800\" && Felt == \"Totalt i retning KRISTIANSAND\") ||\r\n(Trafikkregistreringspunkt == \"99454V104306\" && Felt == \"Totalt i retning Lund\") ||\r\n(Trafikkregistreringspunkt == \"98936V121303\" && Felt == \"Totalt i retning Kristiansand\") ||\r\n(Trafikkregistreringspunkt == \"73380V121327\" && Felt == \"Totalt i retning Prestheia\")) ~> Filter1\nSelect1 derive({Tung transport} = {Tung transport}+{5,6m - 7,6m}+{7,6m - 12,5m}+{12,5m - 16,0m}+{16,0m - 24,0m}+{>= 24,0m}) ~> DerivedColumn1\nFilter1 select(mapColumn(\n\t\tTrafikkregistreringspunkt,\n\t\tNavn,\n\t\tDato = Fra,\n\t\tVolum,\n\t\tFelt,\n\t\t{Lett transport} = {< 5,6m},\n\t\t{Tung transport} = {>= 5,6m},\n\t\t{5,6m - 7,6m},\n\t\t{7,6m - 12,5m},\n\t\t{12,5m - 16,0m},\n\t\t{16,0m - 24,0m},\n\t\t{>= 24,0m}\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> Select1\nsource1 filter((Trafikkregistreringspunkt == \"68804V121330\" && Felt == \"Totalt i retning Oddernestunnelen\") ||\r\n(Trafikkregistreringspunkt == \"22540V121303\" && Felt == \"Totalt i retning KRISTIANSAND\")) ~> Filter2\nFilter2 derive(Prestebekken = case(Trafikkregistreringspunkt == '22540V121303', Volum),\n\t\t{Prestebekken rampe} = case(Trafikkregistreringspunkt == '68804V121330', Volum)) ~> DerivedColumn3\nDerivedColumn3 aggregate(groupBy(Fra),\n\t{Bjørndalssletta} = minus(sum(Prestebekken),sum({Prestebekken rampe}))) ~> Aggregate2\nDerivedColumn1, Aggregate2 join(Dato == Fra,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> Join1\nsource1 filter((Trafikkregistreringspunkt == \"04813V121368\" && Felt == \"Totalt i retning Kristiansand\") ||\n(Trafikkregistreringspunkt == \"98936V121303\" && Felt == \"Totalt i retning Kristiansand\")) ~> Filter3\nFilter3 derive(Vesterveien = case(Trafikkregistreringspunkt == '98936V121303', Volum),\n\t\t{Vesterveien rampe} = case(Trafikkregistreringspunkt == '04813V121368', Volum)) ~> DerivedColumn4\nDerivedColumn4 aggregate(groupBy(Fra),\n\tVesterveien = minus(sum(Vesterveien),sum({Vesterveien rampe}))) ~> Aggregate3\nJoin1, Aggregate3 join(Dato == Aggregate3@Fra,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> Join2\nJoin2 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'table',\n\tstore: 'sqlserver',\n\tschemaName: 'dbo',\n\ttableName: 'SVV_Trafikkdata',\n\tinsertable: true,\n\tupdateable: false,\n\tdeletable: false,\n\tupsertable: false,\n\trecreate: true,\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tmapColumn(\n\t\tTrafikkregistreringspunkt,\n\t\tNavn,\n\t\tDato,\n\t\tVolum,\n\t\tFelt,\n\t\t{Lett transport},\n\t\t{Tung transport}\n\t)) ~> sink1"
		}
	}
}